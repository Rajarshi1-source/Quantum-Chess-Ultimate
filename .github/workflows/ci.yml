# Quantum Chess Ultimate — CI/CD Pipeline

name: CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ─── Backend Tests ──────────────────────────────────
  backend-tests:
    name: Backend Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read

    defaults:
      run:
        working-directory: backend

    steps:
      - name: Checkout code
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: "3.12"
          cache: pip
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio httpx

      - name: Run tests
        env:
          DATABASE_URL: "postgresql+asyncpg://postgres:postgres@localhost:5432/quantum_chess"
          ENVIRONMENT: "test"
          LOG_LEVEL: "warning"
        run: python -m pytest tests/ -v --tb=short -q

      - name: Type check
        run: |
          pip install mypy
          mypy app/ --ignore-missing-imports || true

  # ─── Frontend Tests ─────────────────────────────────
  frontend-tests:
    name: Frontend Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout code
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: "22"
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: TypeScript check
        run: npx tsc --noEmit

      - name: Run unit tests
        run: npx vitest run --reporter=verbose

      - name: Build
        run: npm run build

      # ✅ NEW: Cache the build artifact for E2E job to reuse,
      # avoiding a second full npm build in the downstream job.
      - name: Upload build artifact
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0b082b0a9e2 # v4.6.0
        with:
          name: frontend-dist
          path: frontend/dist/
          retention-days: 1

  # ─── E2E Tests ──────────────────────────────────────────────
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    permissions:
      contents: read
      actions: read         # Required to download artifacts from upstream jobs

    steps:
      - name: Checkout code
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: "3.12"
          cache: pip
          cache-dependency-path: backend/requirements.txt

      - name: Set up Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: "22"
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install root Playwright dependencies
        run: npm ci

      - name: Install backend Python deps
        working-directory: backend
        run: pip install -r requirements.txt

      - name: Install frontend Node deps
        working-directory: frontend
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      # ✅ FIX: Start backend with ALL required env vars before E2E.
      # Without DATABASE_URL, the FastAPI app crashes immediately.
      # Using a service container or inline start — inline shown here
      # for simplicity since there's no real DB needed for E2E mocking.
      - name: Start backend server
        working-directory: backend
        env:
          DATABASE_URL: "postgresql+asyncpg://postgres:postgres@localhost:5432/quantum_chess"
          ENVIRONMENT: "test"
          CORS_ORIGINS: "http://localhost:5173"
          LOG_LEVEL: "warning"
        run: |
          python -m uvicorn app.main:app --port 8000 &
          echo "Backend PID: $!"
          # ✅ FIX: Replace brittle `sleep 10` with an actual readiness check
          timeout 30 bash -c 'until curl -sf http://localhost:8000/health; do sleep 1; done'
          echo "Backend is ready"

      - name: Start frontend dev server
        working-directory: frontend
        run: |
          npm run dev &
          timeout 30 bash -c 'until curl -sf http://localhost:5173; do sleep 1; done'
          echo "Frontend is ready"

      - name: Run E2E tests
        run: npx playwright test --project=chromium
        env:
          CI: true

      - name: Upload Playwright report on failure
        if: failure()
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0b082b0a9e2 # v4.6.0
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

  # ─── Docker Build ───────────────────────────────────
  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    permissions:
      contents: read

    steps:
      - name: Checkout code
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@f7ce41bc8d00b7e78516a05e848bcab90c07e6b8 # v3.9.0

      - name: Build backend image
        uses: docker/build-push-action@ca877d9245402d1537745e0e356cc1b9e50a9a7c # v6.13.0
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: false
          tags: quantum-chess-backend:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build frontend image
        uses: docker/build-push-action@ca877d9245402d1537745e0e356cc1b9e50a9a7c # v6.13.0
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: false
          tags: quantum-chess-frontend:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test Docker Compose startup
        env:
          DATABASE_URL: "postgresql+asyncpg://postgres:postgres@localhost:5432/quantum_chess"
        run: |
          docker compose up -d backend
          echo "Waiting for backend container to become healthy..."
          timeout 60 bash -c '
            until [ "$(docker inspect --format="{{.State.Health.Status}}" quantum_chess_backend)" = "healthy" ]; do
              echo "Still waiting... $(docker inspect --format="{{.State.Health.Status}}" quantum_chess_backend)"
              sleep 3
            done
          '
          echo "Backend container is healthy"
          docker compose logs backend

          docker compose up -d frontend
          echo "Waiting for frontend container to become ready..."
          timeout 30 bash -c 'until curl -sf http://localhost:5173; do sleep 1; done'
          echo "Frontend is ready"

          docker compose down
          echo "Docker Compose stopped"
